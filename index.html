<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Rasta Bazaar â€” ØªØ¬Ù‡ÛŒØ²Ø§Øª Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø¯Ø³Øªâ€ŒØ¯ÙˆÙ…</title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2563eb">
<link rel="apple-touch-icon" href="icon-180.png">

<style>
:root{
  --bg:#f6f8fc; --fg:#0b1020; --muted:#6b7280;
  --primary:#2563eb; --primary-2:#60a5fa;
  --border:#e6e8ef; --surface:#fff;
  --shadow:0 18px 44px rgba(2,6,23,.08); --shadow-sm:0 10px 24px rgba(2,6,23,.06);
  --r-xl:22px; --r-lg:16px; --r-md:12px;
}
*{box-sizing:border-box}
body{
  margin:0; background:
    radial-gradient(1000px 520px at 110% -10%, rgba(96,165,250,.15), transparent 60%),
    radial-gradient(900px 520px at -10% 120%, rgba(125,211,252,.12), transparent 60%),
    var(--bg);
  color:var(--fg);
  font:16px/1.7 "Vazirmatn","IRANSans",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
}

/* Header */
header{background:linear-gradient(120deg,var(--primary),var(--primary-2)); color:#fff; box-shadow:var(--shadow)}
.head{max-width:1100px; margin:0 auto; padding:16px; display:flex; gap:12px; align-items:center; justify-content:space-between}
h1{margin:0; font-size:20px; font-weight:900}
.head .actions{display:flex; gap:8px; align-items:center}
.btn, .btn-outline{
  padding:10px 14px; border-radius:12px; border:0; font-weight:900; cursor:pointer;
}
.btn{color:#fff; background:linear-gradient(120deg,#3b82f6,#60a5fa); box-shadow:0 10px 22px rgba(59,130,246,.25)}
.btn-outline{background:#fff; color:var(--primary); border:2px solid var(--primary)}
.wrap{max-width:1100px; margin:20px auto; padding:0 16px}

/* Sections */
.section{background:var(--surface); border:1px solid var(--border); border-radius:var(--r-xl); box-shadow:var(--shadow); overflow:hidden}
.sec-header{display:flex; align-items:center; gap:10px; padding:12px 16px; background:linear-gradient(180deg,#fff,#f9fbff); border-bottom:1px solid var(--border)}
.sec-title{margin:0; font-size:16px; font-weight:900; color:#1f2937}
.sec-body{padding:16px}

/* Form */
.form{display:grid; gap:12px; grid-template-columns:repeat(2,minmax(240px,1fr))}
@media (max-width:820px){.form{grid-template-columns:1fr}}
label{display:block; font-size:12px; font-weight:800; color:#334155; margin:4px 2px}
.control{display:flex; align-items:center; gap:10px; background:#f8fbff; border:1px solid var(--border); border-radius:var(--r-md); padding:10px 12px}
input[type="text"], input[type="number"], textarea{
  width:100%; border:0; outline:0; background:transparent; font-weight:800; color:var(--fg);
}
input[type="file"]{width:100%}
textarea{min-height:92px; resize:vertical; font-weight:600}
.suffix{font-size:12px; color:var(--muted)}
.row{display:flex; align-items:center; gap:10px; flex-wrap:wrap; margin-top:6px}
.err{display:none; margin-top:6px; color:#ef4444; font-size:13px}
.note{font-size:12px; color:#64748b}

/* Toolbar */
.toolbar{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
.search{flex:1; min-width:220px}
select{border:1px solid var(--border); border-radius:10px; padding:8px 10px; background:#fff; font-weight:700}
input[type="search"]{width:100%; border:1px solid var(--border); border-radius:10px; padding:10px 12px; background:#fff; font-weight:700}

/* Tabs */
.tabs{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px}
.tabs .btn{padding:8px 12px}

/* Grid of items */
.grid{display:grid; gap:14px; grid-template-columns:repeat(3,minmax(220px,1fr))}
@media (max-width:1100px){.grid{grid-template-columns:repeat(2,minmax(220px,1fr))}}
@media (max-width:640px){.grid{grid-template-columns:1fr}}

.item{background:#fff; border:1px solid var(--border); border-radius:16px; box-shadow:var(--shadow-sm); overflow:hidden; display:flex; flex-direction:column}
.thumb{aspect-ratio:4/3; width:100%; object-fit:cover; background:#f3f4f6}
.item .content{padding:12px}
.item h3{margin:.2rem 0 .4rem; font-size:15px; font-weight:900; color:#111827}
.meta{display:flex; align-items:center; justify-content:space-between; gap:8px; margin-top:6px}
.price{font-size:18px; font-weight:900; color:#111827}
.controls{display:flex; gap:8px; margin-top:10px}
.badge{display:inline-block; padding:2px 8px; border-radius:999px; background:#eff6ff; border:1px solid #dbeafe; color:#1d4ed8; font-size:12px}

/* Auth badge */
.user-badge{display:inline-flex; align-items:center; gap:8px; background:#ffffffaa; color:#0b1020; padding:6px 10px; border-radius:999px; font-weight:800;}
.user-badge small{color:#374151}

/* Modal */
.modal-backdrop{position:fixed; inset:0; background:rgba(15,23,42,.5); display:none; align-items:center; justify-content:center; z-index:50}
.modal{width:min(520px,92vw); background:#fff; border:1px solid var(--border); border-radius:18px; box-shadow:var(--shadow); overflow:hidden}
.modal .hd{display:flex; align-items:center; justify-content:space-between; padding:12px 16px; border-bottom:1px solid var(--border); background:#f9fbff}
.modal .bd{padding:16px}
.modal .ft{padding:12px 16px; border-top:1px solid var(--border); display:flex; gap:8px; justify-content:flex-end}

/* Banner for missing config */
.banner{max-width:1100px; margin:14px auto 0; padding:12px 16px; color:#1f2937; background:#fff8c5; border:1px solid #fde68a; border-radius:12px}
</style>
</head>
<body>

<header>
  <div class="head">
    <h1>Rasta Bazaar â€” ØªØ¬Ù‡ÛŒØ²Ø§Øª Ù…Ù‡Ù†Ø¯Ø³ÛŒ Ø¯Ø³Øªâ€ŒØ¯ÙˆÙ…</h1>
    <div class="actions">
      <span id="userBadge" class="user-badge" style="display:none;">ğŸ“± <small id="userPhone"></small></span>
      <button id="loginBtn" class="btn-outline">ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
      <button id="logoutBtn" class="btn-outline" style="display:none">Ø®Ø±ÙˆØ¬</button>
    </div>
  </div>
</header>

<!-- Auth Modal -->
<div id="authModal" class="modal-backdrop">
  <div class="modal">
    <div class="hd">
      <strong>ÙˆØ±ÙˆØ¯ / Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆØ¨Ø§ÛŒÙ„</strong>
      <button id="authClose" style="background:none;border:0;font-size:18px;cursor:pointer">âœ–</button>
    </div>
    <div class="bd">
      <label for="phone" style="display:block; font-weight:800; margin-bottom:6px">Ø´Ù…Ø§Ø±Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„</label>
      <div class="control">
        <input id="phone" type="text" inputmode="tel" placeholder="Ù…Ø«Ù„Ø§Ù‹ 09123456789" style="direction:ltr; text-align:left">
      </div>
      <p class="note" style="margin-top:8px">
        Ú©Ø¯ ØªØ£ÛŒÛŒØ¯ (OTP) Ø§Ø² Ø·Ø±ÛŒÙ‚ Firebase Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù„Ø·ÙØ§Ù‹ Ø¯Ø§Ù…Ù†Ù‡ GitHub Pages Ø®ÙˆØ¯ Ø±Ø§ Ø¯Ø± Authorized Domains Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯.
      </p>
      <div id="authErr" class="err">Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ø­Ø¯Ø§Ù‚Ù„ 10 Ø±Ù‚Ù…).</div>
    </div>
    <div class="ft">
      <button id="authOk" class="btn">Ø§Ø±Ø³Ø§Ù„ Ú©Ø¯ Ùˆ ÙˆØ±ÙˆØ¯</button>
    </div>
  </div>
</div>

<!-- Tabs + Search -->
<main class="wrap">
  <div id="cfgBanner" class="banner" style="display:none">
    âš ï¸ Ø§Ø¨ØªØ¯Ø§ <strong>Firebase config</strong> Ø±Ø§ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ ÙØ§ÛŒÙ„ Ù¾Ø± Ú©Ù†ÛŒØ¯Ø› Ø³Ù¾Ø³ ØµÙØ­Ù‡ Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯.
  </div>

  <!-- Form -->
  <section class="section" style="margin-top:14px">
    <div class="sec-header">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 7h16M4 12h12M4 17h10" stroke="#334155" stroke-width="1.8" stroke-linecap="round"/></svg>
      <h2 class="sec-title">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</h2>
    </div>
    <div class="sec-body">
      <div class="form">
        <div>
          <label for="title">Ø¹Ù†ÙˆØ§Ù† (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <div class="control"><input id="title" type="text" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø¯ÙˆØ±Ø¨ÛŒÙ† Ù†Ù‚Ø´Ù‡â€ŒØ¨Ø±Ø¯Ø§Ø±ÛŒ Leica TS06"></div>
        </div>
        <div>
          <label for="price">Ù‚ÛŒÙ…Øª (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
          <div class="control">
            <input id="price" type="text" inputmode="decimal" placeholder="Ù…Ø«Ù„Ø§Ù‹ Û±Û²Ù¬ÛµÛ°Û°Ù¬Û°Û°Û°">
            <span class="suffix">ØªÙˆÙ…Ø§Ù†</span>
          </div>
        </div>
        <div style="grid-column:1/-1">
          <label for="photo">Ø¹Ú©Ø³ ØªØ¬Ù‡ÛŒØ² (Ø§Ø¬Ø¨Ø§Ø±ÛŒ)</label>
          <div class="control"><input id="photo" type="file" accept="image/*" capture="environment"></div>
          <div class="note">Ø¹Ú©Ø³ Ø¨Ø±Ø§ÛŒ Ø³Ø±Ø¹Øª ØªØ§ Ø¹Ø±Ø¶ ~1200px ÙØ´Ø±Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>
        <div style="grid-column:1/-1">
          <label for="desc">ØªÙˆØ¶ÛŒØ­ Ú©ÙˆØªØ§Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label>
          <div class="control"><textarea id="desc" placeholder="Ø³Ø§Ù„ Ø³Ø§Ø®ØªØŒ ÙˆØ¶Ø¹ÛŒØª Ø³Ù„Ø§Ù…ØªØŒ Ù„ÙˆØ§Ø²Ù… Ø¬Ø§Ù†Ø¨ÛŒ..."></textarea></div>
        </div>
      </div>
      <div class="row">
        <label style="display:flex; align-items:center; gap:8px; font-weight:800">
          <input id="isPublic" type="checkbox" checked>
          Ø§Ù†ØªØ´Ø§Ø± Ø¹Ù…ÙˆÙ…ÛŒ (Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Â«Ù‡Ù…Ù‡Ù” Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§Â»)
        </label>
      </div>
      <div class="row">
        <button id="addBtn" class="btn">Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ</button>
        <div id="err" class="err">Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒØŒ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯Ø› Ø³Ù¾Ø³ Ø¹Ú©Ø³ Ùˆ Ù‚ÛŒÙ…Øª Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯.</div>
      </div>
    </div>
  </section>

  <!-- Toolbar + Tabs -->
  <section class="section" style="margin-top:16px">
    <div class="sec-header">
      <svg width="20" height="20" viewBox="0 0 24 24" aria-hidden="true"><path d="M10 17l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" stroke="#059669" stroke-width="1.8" fill="none"/></svg>
      <h2 class="sec-title">ÙÙ‡Ø±Ø³Øª Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§</h2>
    </div>
    <div class="sec-body">
      <div class="tabs">
        <button id="tabPublic"  class="btn">Ù‡Ù…Ù‡Ù” Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ (Ø¹Ù…ÙˆÙ…ÛŒ)</button>
        <button id="tabMine"    class="btn-outline">Ø¢Ú¯Ù‡ÛŒâ€ŒÙ‡Ø§ÛŒ Ù…Ù†</button>
      </div>
      <div class="toolbar">
        <input id="q" class="search" type="search" placeholder="Ø¬Ø³Øªâ€ŒÙˆØ¬Ùˆ Ø¯Ø± Ø¹Ù†ÙˆØ§Ù†/ØªÙˆØ¶ÛŒØ­...">
        <select id="sort">
          <option value="new">Ù…Ø±ØªØ¨â€ŒØ³Ø§Ø²ÛŒ: Ø¬Ø¯ÛŒØ¯ØªØ±ÛŒÙ†</option>
          <option value="price_asc">Ù‚ÛŒÙ…Øª Ø§Ø² Ú©Ù… Ø¨Ù‡ Ø²ÛŒØ§Ø¯</option>
          <option value="price_desc">Ù‚ÛŒÙ…Øª Ø§Ø² Ø²ÛŒØ§Ø¯ Ø¨Ù‡ Ú©Ù…</option>
          <option value="title">Ø¹Ù†ÙˆØ§Ù† (Ø§Ù„ÙØ¨Ø§)</option>
        </select>
      </div>
    </div>
  </section>

  <!-- Grid -->
  <section class="section" style="margin-top:12px">
    <div class="sec-body">
      <div id="grid" class="grid"></div>
      <p id="emptyNote" class="note" style="display:none; padding:10px 2px">Ø¢Ú¯Ù‡ÛŒâ€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯.</p>
    </div>
  </section>
</main>

<footer class="wrap" style="margin-bottom:28px">
  Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± <strong>Cloud Firestore</strong> Ùˆ ØªØµØ§ÙˆÛŒØ± Ø¯Ø± <strong>Firebase Storage</strong> Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯. Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¹Ù…ÙˆÙ…ÛŒØŒ Ú¯Ø²ÛŒÙ†Ù‡Ù” Â«Ø§Ù†ØªØ´Ø§Ø± Ø¹Ù…ÙˆÙ…ÛŒÂ» Ø±Ø§ ÙØ¹Ø§Ù„ Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯.
</footer>

<!-- reCAPTCHA container (invisible) -->
<div id="recaptcha-container" style="display:none"></div>

<!-- Ø«Ø¨Øª Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> navigator.serviceWorker.register('sw.js'));
}
</script>

<!-- ===== Firebase Ù†Ø³Ø®Ù‡ OTP + Cloud (Ù…Ø§Ú˜ÙˆÙ„Ø§Ø±) ===== -->
<script type="module">
/* ===== Firebase SDK (v10 modular) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getAuth, RecaptchaVerifier, signInWithPhoneNumber, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, onSnapshot, addDoc, deleteDoc, doc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

/* ===== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Firebase â€” Ø§ÛŒÙ†Ø¬Ø§ Ø±Ø§ Ø§Ø² Ú©Ù†Ø³ÙˆÙ„ Ú©Ù¾ÛŒ Ú©Ù† ===== */
const firebaseConfig = {
â€Â  apiKey: "AIzaSyDO7WjiVituiRULoORMrv5R_mVa14JhrgQ",
â€Â  authDomain: "rasta-bazar-57d80.firebaseapp.com",
â€Â  projectId: "rasta-bazar-57d80",
â€Â  storageBucket: "rasta-bazar-57d80.firebasestorage.app",
â€Â  messagingSenderId: "826759050427",
â€Â  appId: "1:826759050427:web:985fc4895993db7e56259e",
â€Â  measurementId: "G-ZZ0MM9S0N2"
};
const cfgBanner = document.getElementById('cfgBanner');
if (!firebaseConfig || !firebaseConfig.apiKey) {
  cfgBanner.style.display = 'block';
  throw new Error('Firebase config missing');
}

/* ===== Init ===== */
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);
const stg  = getStorage(app);

/* ===== DOM refs ===== */
const $=id=>document.getElementById(id);
const inpTitle=$('title'), inpPrice=$('price'), inpPhoto=$('photo'), inpDesc=$('desc'), isPublic=$('isPublic');
const addBtn=$('addBtn'), err=$('err');
const q=$('q'), sort=$('sort'), grid=$('grid'), emptyNote=$('emptyNote');

const loginBtn=$('loginBtn'), logoutBtn=$('logoutBtn'), userBadge=$('userBadge'), userPhoneEl=$('userPhone');
const authModal=$('authModal'), authOk=$('authOk'), authClose=$('authClose'), authErr=$('authErr'), phoneInp=$('phone');

const tabPublic=$('tabPublic'), tabMine=$('tabMine');

/* ===== Utils ===== */
const fa=/[Û°-Û¹]/g, ar=/[Ù -Ù©]/g;
const maps={fa:{'Û°':0,'Û±':1,'Û²':2,'Û³':3,'Û´':4,'Ûµ':5,'Û¶':6,'Û·':7,'Û¸':8,'Û¹':9}, ar:{'Ù ':0,'Ù¡':1,'Ù¢':2,'Ù£':3,'Ù¤':4,'Ù¥':5,'Ù¦':6,'Ù§':7,'Ù¨':8,'Ù©':9}};
function toNumber(v){ if(v==null) return NaN; let s=String(v).trim().replace(/\s+/g,'').replace(/,/g,'').replace(/Ù¬/g,''); s=s.replace(fa,d=>maps.fa[d]).replace(ar,d=>maps.ar[d]); return Number(s); }
function formatPrice(n){ if(!isFinite(n)) return 'â€”'; return n.toLocaleString('fa-IR'); }
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[m])); }
function compressImage(file, maxW=1200, quality=0.82){
  return new Promise((resolve,reject)=>{
    const reader=new FileReader();
    reader.onload=()=>{ const img=new Image(); img.onload=()=>{
      const scale=Math.min(1, maxW/img.width), w=Math.round(img.width*scale), h=Math.round(img.height*scale);
      const canvas=document.createElement('canvas'); canvas.width=w; canvas.height=h;
      const ctx=canvas.getContext('2d'); ctx.drawImage(img,0,0,w,h);
      let url; try{ url=canvas.toDataURL('image/jpeg', quality);}catch(e){url=canvas.toDataURL();}
      resolve(url);
    }; img.onerror=()=>reject(new Error('bad image')); img.src=reader.result; };
    reader.onerror=()=>reject(new Error('read error')); reader.readAsDataURL(file);
  });
}
async function dataURLtoBlob(dataURL){ const res=await fetch(dataURL); return await res.blob(); }

/* ===== Auth (Phone + OTP) ===== */
let currentUser = null;
let confirmation = null;
let recaptcha = null;

function showAuthUI(user){
  if(user){
    userBadge.style.display='inline-flex';
    userPhoneEl.textContent = user.phoneNumber || 'ÙˆØ±ÙˆØ¯';
    loginBtn.style.display='none';
    logoutBtn.style.display='inline-block';
  } else {
    userBadge.style.display='none';
    userPhoneEl.textContent = '';
    loginBtn.style.display='inline-block';
    logoutBtn.style.display='none';
  }
}

loginBtn.addEventListener('click', ()=>{
  authModal.style.display='flex';
  authErr.style.display='none';
  phoneInp.value='';
  if(!recaptcha){
    recaptcha = new RecaptchaVerifier(auth, 'recaptcha-container', { size: 'invisible' });
  }
});

authOk.onclick = async ()=>{
  const raw = (phoneInp.value||'').trim();
  const digits = raw.replace(/\D+/g,'');
  if(digits.length < 10){ authErr.textContent='Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹ØªØ¨Ø± Ù†ÛŒØ³Øª.'; authErr.style.display='block'; return; }
  // Ù†Ù…ÙˆÙ†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ±Ø§Ù†: +98
  const e164 = digits.startsWith('0') ? '+98'+digits.slice(1) : (digits.startsWith('+')? digits : '+98'+digits);
  try{
    confirmation = await signInWithPhoneNumber(auth, e164, recaptcha);
    const code = prompt('Ú©Ø¯ Ù¾ÛŒØ§Ù…Ú©ÛŒ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:');
    if(!code) return;
    await confirmation.confirm(code);
    authModal.style.display='none';
  }catch(err){
    authErr.textContent='Ø§Ø±Ø³Ø§Ù„/ØªØ£ÛŒÛŒØ¯ Ú©Ø¯ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯: '+(err.message||err);
    authErr.style.display='block';
  }
};
authClose.onclick = ()=> authModal.style.display='none';
logoutBtn.onclick = ()=> signOut(auth);

/* ===== Feed (public | mine) ===== */
let FEED = 'public';
let unsub = null;
let cache = [];

function refreshTabsUI(){
  tabPublic.classList.toggle('btn', FEED==='public');
  tabPublic.classList.toggle('btn-outline', FEED!=='public');
  tabMine.classList.toggle('btn', FEED==='mine');
  tabMine.classList.toggle('btn-outline', FEED!=='mine');
}
tabPublic.addEventListener('click', ()=>{ FEED='public'; refreshTabsUI(); bindFeed(); });
tabMine.addEventListener('click',   ()=>{ FEED='mine';   refreshTabsUI(); bindFeed(); });

function bindFeed(){
  if(unsub){ unsub(); unsub=null; }
  cache = [];
  render();

  if(FEED === 'public'){
    const col = collection(db, 'items');
    const qy  = query(col, where('status','==','public'), orderBy('ts','desc'));
    unsub = onSnapshot(qy, (snap)=>{
      cache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      render();
    });
  }else{
    if(!currentUser){ cache=[]; render(); return; }
    const col = collection(db, 'items');
    const qy  = query(col, where('uid','==', currentUser.uid), orderBy('ts','desc'));
    unsub = onSnapshot(qy, (snap)=>{
      cache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      render();
    });
  }
}

/* ===== Render ===== */
function filteredSorted(){
  let list = cache.slice();
  const queryStr = q.value.trim().toLowerCase();
  if(queryStr) list = list.filter(x=>(x.title||'').toLowerCase().includes(queryStr) || (x.desc||'').toLowerCase().includes(queryStr));
  const mode = sort.value;
  if(mode==='price_asc') list.sort((a,b)=>a.price-b.price);
  else if(mode==='price_desc') list.sort((a,b)=>b.price-a.price);
  else if(mode==='title') list.sort((a,b)=>(a.title||'').localeCompare(b.title||''));
  else list.sort((a,b)=> (b.ts?.toMillis?.() ?? b.ts) - (a.ts?.toMillis?.() ?? a.ts));
  return list;
}

function render(){
  const list = filteredSorted();
  grid.innerHTML='';
  emptyNote.style.display = list.length ? 'none' : 'block';
  list.forEach(it=>{
    const dateStr = (it.ts?.toDate?.() ? it.ts.toDate() : new Date(it.ts)).toLocaleDateString('fa-IR');
    const isOwner = currentUser && it.uid === currentUser.uid;
    const el=document.createElement('div'); el.className='item';
    el.innerHTML = `
      <img class="thumb" alt="photo" src="${it.photoURL}">
      <div class="content">
        <h3>${it.title? escapeHtml(it.title) : 'Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†'}</h3>
        <div class="meta">
          <div class="price">${formatPrice(it.price)} <span class="badge">ØªÙˆÙ…Ø§Ù†</span></div>
          <div class="badge">${dateStr}</div>
        </div>
        ${it.desc ? `<p class="note" style="margin-top:8px">${escapeHtml(it.desc)}</p>` : ``}
        <div class="controls">
          ${isOwner ? `<button class="btn-outline" data-del="${it.id}">Ø­Ø°Ù</button>` : ``}
          <a class="btn-outline" href="${it.photoURL}" download="photo.jpg">Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø¹Ú©Ø³</a>
        </div>
      </div>`;
    grid.appendChild(el);
  });

  grid.querySelectorAll('[data-del]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-del');
      if(!id || !currentUser) return;
      await deleteDoc(doc(db, 'items', id));
    });
  });
}

q.addEventListener('input', render);
sort.addEventListener('change', render);

/* ===== Add new item ===== */
addBtn.addEventListener('click', async ()=>{
  err.style.display='none';
  if(!currentUser){ err.textContent='Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.'; err.style.display='block'; return; }

  const file = inpPhoto.files && inpPhoto.files[0];
  const priceNum = toNumber(inpPrice.value);
  if(!file || !isFinite(priceNum) || priceNum<=0){
    err.textContent='Ø¹Ú©Ø³ Ùˆ Ù‚ÛŒÙ…Øª Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª.'; err.style.display='block'; return;
  }
  try{
    // compress locally
    const dataURL = await compressImage(file);
    const blob    = await dataURLtoBlob(dataURL);

    // upload to Storage under user path
    const itemId = crypto.randomUUID ? crypto.randomUUID() : String(Date.now()+Math.random());
    const path   = `users/${currentUser.uid}/items/${itemId}.jpg`;
    const r      = ref(stg, path);
    await uploadBytes(r, blob, { contentType: 'image/jpeg' });
    const url    = await getDownloadURL(r);

    // save Firestore doc
    await addDoc(collection(db, 'items'), {
      uid: currentUser.uid,
      title: (inpTitle.value||'').trim(),
      price: Math.round(priceNum),
      desc: (inpDesc.value||'').trim(),
      photoURL: url,
      status: isPublic.checked ? 'public' : 'private',
      ts: serverTimestamp()
    });

    // reset form
    inpTitle.value=''; inpPrice.value=''; inpDesc.value=''; inpPhoto.value='';
  }catch(e){
    err.textContent='Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø¢Ú¯Ù‡ÛŒ: '+(e.message||e);
    err.style.display='block';
  }
});

/* ===== Auth state ===== */
onAuthStateChanged(auth, (user)=>{
  currentUser = user || null;
  showAuthUI(currentUser);
  bindFeed();
});

/* ===== boot ===== */
refreshTabsUI();
bindFeed();
</script>
</body>
</html>
